var locations={locationsArray:[{title:"Whiskey Thieves",yelpURL:"http://api.yelp.com/v2/business/whiskey-thieves-san-francisco",location:{lat:37.7860926,lng:-122.4171254},},{title:"Nihon Whisky Lounge",yelpURL:"http://api.yelp.com/v2/business/nihon-whisky-lounge-san-francisco",location:{lat:37.768697,lng:-122.41529},},{title:"Rickhouse",yelpURL:"http://api.yelp.com/v2/business/rickhouse-san-francisco",location:{lat:37.7904968261719,lng:-122.403594970703},},{title:"Hard Water",yelpURL:"http://api.yelp.com/v2/business/hard-water-san-francisco",location:{lat:37.797501,lng:-122.395484},},{title:"Rye",yelpURL:"http://api.yelp.com/v2/business/rye-san-francisco",location:{lat:37.78677,lng:-122.41461},},]};var yelpAPI=function(i){function nonce_generate(){return(Math.floor(Math.random()*1e12).toString())}
var yelp_url=locations.locationsArray[i].yelpURL;var parameters={oauth_consumer_key:"QJR3xjIwW9d9jnCjLBTzXQ",oauth_token:"zEwwDoGQU78dheH4id-wxVpaR5jwyDu2",oauth_nonce:nonce_generate(),oauth_timestamp:Math.floor(Date.now()/1000),oauth_signature_method:"HMAC-SHA1",oauth_version:"1.0",callback:"cb",limit:1};var encodedSignature=oauthSignature.generate("GET",yelp_url,parameters,"tc2X8lqfCR4GeVCoStbnPyo4nds","vXE_E2P7ryml6qhzqYaObKLhcdA");parameters.oauth_signature=encodedSignature;var settings={url:yelp_url,data:parameters,cache:!0,dataType:"jsonp",error:function(){alert("Yelp information is not accessible at this time.")}};$.ajax(settings).done(function(results){var yelpLocations=results.reviews;locations.locationsArray[i].result=results;locations.locationsArray[i].ratingImg=results.rating_img_url;locations.locationsArray[i].snippetImg=results.snippet_image_url;locations.locationsArray[i].snippetText=results.snippet_text})};var map;var largeInfoWindow;var bounds;function initMap(){largeInfoWindow=new google.maps.InfoWindow();bounds=new google.maps.LatLngBounds();map=new google.maps.Map(document.getElementById("map"),{center:{lat:37.7701612271937,lng:-122.415708343283},zoom:13});var locLength=locations.locationsArray.length;for(var i=0;i<locLength;i++){yelpAPI(i)};var vm=new ViewModel();ko.applyBindings(vm)}
var menu=document.querySelector("#navBar");var main=document.querySelector("#container");var drawer=document.querySelector("#drawer");menu.addEventListener("click",function(e){drawer.classList.toggle("open");e.stopPropagation()});main.addEventListener("click",function(){drawer.classList.remove("open")});var ViewModel=function(){var self=this;self.filter=ko.observable(""),self.locationList=ko.observableArray(locations.locationsArray),self.locationList().forEach(function(bar){var marker=new google.maps.Marker({map:map,position:bar.location,title:bar.title,animation:google.maps.Animation.DROP,});marker.addListener("click",toggleBounce);function toggleBounce(){if(marker.getAnimation()!=null){marker.setAnimation(null)}else{marker.setAnimation(google.maps.Animation.BOUNCE)}}
bar.markerLocation=marker;var gEvent=google.maps.event;gEvent.addListener(marker,"click",function(marker,infowindow){return function(){if(infowindow.marker!=marker){infowindow.marker=marker;console.log(bar.ratingImg);var content="<h3>"+bar.title+"</h3>"+"<img src="+bar.ratingImg+"></div>"+"<div><img src="+bar.snippetImg+"></div>"+"<div>"+bar.snippetText+"</div>"
infowindow.setContent(content);infowindow.open(map,marker);infowindow.addListener("closeClick",function(){infowindow.setMarker(null)});console.log(infowindow)}else{console.log("fail")}}}(marker,largeInfoWindow,map));bounds.extend(bar.markerLocation.position)});filteredLocations=ko.computed(function(){filter=self.filter().toLowerCase();if(!filter){return self.locationList()}else{return ko.utils.arrayFilter(self.locationList(),function(loc){var match=loc.title.toLowerCase().indexOf(filter)>=0;loc.markerLocation.setVisible(match);return match})}})
self.curLocation=function(bar){google.maps.event.trigger(bar.markerLocation,"click")}}